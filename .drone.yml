pipeline:

  restore-cache:
      image: drillster/drone-volume-cache
      restore: true
      mount:
        - ./node_modules
      volumes:
        - /tmp/cache:/cache

  install-deps:
    image: node:6
    environment:
      - NPM_CONFIG_LOGLEVEL=warn
    commands:
      - curl -o- -L https://yarnpkg.com/install.sh | bash
      - yarn --no-lockfile

  lint-and-test:
    group: parallel
    image: node:6
    commands:
      - npm run lint
      - npm run lint-style
      - npm run typecheck
      - npm test

  generate-changelog:
    image: node:6
    secrets: [ changelog_github_token ]
    commands:
      - git pull --ff-only origin master
      - git config --global user.name "nemobot";
      - git config --global user.email "our-bots@buildo.io";
      - node_modules/smooth-release/smooth-release --changelog --token=$CHANGELOG_GITHUB_TOKEN --no-validations --no-gh-release --no-npm-version --no-npm-publish || true
    when:
      branch: master

  publishReleaseOnGitHub:
    image: node:6
    secrets: [ changelog_github_token ]
    commands:
      - node_modules/smooth-release/smooth-release --gh-release --token=$CHANGELOG_GITHUB_TOKEN --no-validations --no-changelog --no-npm-version --no-npm-publish || true
    when:
      branch: master

  rebuild-cache:
    image: drillster/drone-volume-cache
    rebuild: true
    mount:
      - ./node_modules
    volumes:
      - /tmp/cache:/cache

